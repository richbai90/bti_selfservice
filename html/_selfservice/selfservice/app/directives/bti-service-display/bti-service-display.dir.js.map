{"version":3,"sources":["../../../../_itsm_default_v2_template/app/directives/bti-service-display/bti-service-display.dir.js"],"names":["angular","module","directive","btiServiceDisplayDirective","servicesService","swSession","$q","catServ","$rootScope","$state","wssHelpers","store","wssLogging","$window","restrict","templateUrl","scope","controller","ServiceCategoryDirectiveController","$scope","custServices","selectedCategory","selectCategory","row","col","currCat","_categories","categories","selected","catTreeData","parentCategory","addServicesToCategories","services","i","length","Array","isArray","children","reduce","acc","child","push","service","pk_config_type","split","trim","content","checkActiveSession","then","getCustServices","getCatTreeData","cat","hasOwnProperty","parentlabel","open","map","category","filter","c","deferred","defer","getTreeData","response","resolve","promise","firstOpen","getCategorySize","Math","floor","isFav","serviceId","isDefined","favServices","addFav","subsId","servId","addCustomerFavourite","error","toastType","toastBody","toastTitle","sendToast","delFav","delCustomerFavourite","canRaiseIncident","flg_allow_support","canLogCall","listType","canRaiseRequest","flg_allow_request","canAddFav","hasWebflag","raiseRequest","requestClass","remove","dfId","dfClass","fk_df_support","fk_df_onreq","fk_df_onsub","dataFormID","dataFormClass","getSubscriptionRecord","subs_id","objSubscription","objRequest","serviceDetails","subscription","set","go","logger","vsb_title","selectCategoryGroup","evt","stopPropagation","$on"],"mappings":"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","file":"bti-service-display.dir.js","sourcesContent":["(function () {\r\n  'use strict';\r\n  angular\r\n    .module('swSelfService')\r\n    .directive('btiServiceDisplay', [\r\n      'ServicesService',\r\n      'SWSessionService',\r\n      '$q',\r\n      'ServiceCategoryService',\r\n      '$rootScope',\r\n      '$state',\r\n      'wssHelpers',\r\n      'store',\r\n      'wssLogging',\r\n      '$window',\r\n      btiServiceDisplayDirective,\r\n    ]);\r\n\r\n  function btiServiceDisplayDirective(servicesService, swSession, $q, catServ, $rootScope, $state, wssHelpers, store, wssLogging, $window) {\r\n    return {\r\n      restrict: 'E',\r\n      templateUrl: 'app/directives/bti-service-display/service-display.tpl.html',\r\n      scope: {},\r\n      controller: ServiceCategoryDirectiveController,\r\n    };\r\n\r\n    function ServiceCategoryDirectiveController($scope) {\r\n      $scope.custServices = servicesService;\r\n      var selectedCategory = [0, 0];\r\n\r\n      $scope.selectCategory = function (row, col) {\r\n        $scope.currCat = _categories[row][col];\r\n        $scope.categories[selectedCategory[0]][selectedCategory[1]].selected = false;\r\n        $scope.categories[row][col].selected = true;\r\n        selectedCategory = [row, col];\r\n      };\r\n\r\n      var _categories = [];\r\n      var catTreeData = [];\r\n\r\n      let parentCategory = null;\r\n\r\n      function addServicesToCategories(categories, services) {\r\n        for (var i = 0; i < categories.length; i++) {\r\n          if (Array.isArray(categories[i])) {\r\n            addServicesToCategories(categories[i], services)\r\n          } else {\r\n            if (categories[i].children.length > 0) {\r\n              categories[i].children.reduce((acc, child) => {\r\n                acc.push(child);\r\n                return acc;\r\n              }, categories);\r\n              delete categories[i].children;\r\n              //addServicesToCategories(categories[i], services);\r\n            }\r\n\r\n            categories[i].services = services.reduce(function (acc, service) {\r\n              if (service.pk_config_type.split('->')[0].trim() === categories[i].content) {\r\n                acc.push(service);\r\n              }\r\n\r\n              return acc;\r\n\r\n            }, [])\r\n\r\n          }\r\n        }\r\n      }\r\n\r\n      //Check session, if active then get all services\r\n      swSession.checkActiveSession().then(function () {\r\n        servicesService.getCustServices().then(function (services) {\r\n          getCatTreeData().then(function (categories) {\r\n            _categories.push(categories.reduce(function (acc, cat) {\r\n              if (!cat.hasOwnProperty('children')) {\r\n                cat.children = [];\r\n              }\r\n              if (cat.parentlabel === '') {\r\n                cat.open = true;\r\n                cat.selected = false;\r\n                if (acc.length < 6) {\r\n                  acc.push(cat)\r\n                } else {\r\n                  _categories.push(acc);\r\n                  acc = [];\r\n                  acc.push(cat)\r\n                }\r\n              }\r\n              return acc;\r\n            }, []));\r\n            addServicesToCategories(_categories, services);\r\n            $scope.categories = _categories.map(category => {\r\n              if (Array.isArray(category)) {\r\n                return category.filter(c => c.services.length);\r\n              }\r\n            })\r\n          });\r\n        });\r\n      });\r\n\r\n      function getCatTreeData() {\r\n        var deferred = $q.defer();\r\n        if (catTreeData.length === 0) {\r\n          catServ.getTreeData().then(function (response) {\r\n            catTreeData = response;\r\n            deferred.resolve(catTreeData)\r\n          })\r\n        } else {\r\n          deferred.resolve(catTreeData)\r\n        }\r\n        return deferred.promise;\r\n      }\r\n\r\n      $scope.firstOpen = true;\r\n\r\n      $scope.getCategorySize = function (categories) {\r\n        return Math.floor(12 / categories.length)\r\n      };\r\n\r\n      $scope.isFav = function (serviceId) {\r\n        if (angular.isDefined(servicesService.favServices) && servicesService.favServices[serviceId] === true) {\r\n          return true;\r\n        }\r\n        return false;\r\n      };\r\n\r\n      $scope.addFav = function (subsId, servId) {\r\n        servicesService.addCustomerFavourite(subsId, servId).then(function (response) {\r\n        }, function (error) {\r\n          var toastType = \"error\";\r\n          var toastBody = 'Adding this Service to your list of favourites failed.';\r\n          var toastTitle = \"Service Favourite Failed!\";\r\n          wssLogging.sendToast(toastType, toastBody, toastTitle);\r\n        });\r\n      };\r\n\r\n      $scope.delFav = function (servId) {\r\n        servicesService.delCustomerFavourite(servId).then(function () {\r\n        }, function (error) {\r\n          var toastType = \"error\";\r\n          var toastBody = 'Removing this Service from your list of favourites failed.';\r\n          var toastTitle = \"Service Favourite Failed!\";\r\n          wssLogging.sendToast(toastType, toastBody, toastTitle);\r\n        });\r\n      };\r\n\r\n      $scope.canRaiseIncident = function (service) {\r\n        return (service.flg_allow_support === '1' &&\r\n        $scope.canLogCall() &&\r\n        servicesService.listType !== 'own' &&\r\n        servicesService.listType !== 'unsub');\r\n      };\r\n\r\n      $scope.canRaiseRequest = function (service) {\r\n        return (service.flg_allow_request === '1' &&\r\n        $scope.canLogCall() &&\r\n        servicesService.listType !== 'own' &&\r\n        servicesService.listType !== 'unsub');\r\n      };\r\n\r\n      $scope.canAddFav = function () {\r\n        return (servicesService.listType !== 'own' &&\r\n        servicesService.listType !== 'unsub');\r\n      };\r\n\r\n      $scope.canLogCall = function () {\r\n        return wssHelpers.hasWebflag('OPTION_CAN_LOG_CALLS');\r\n      };\r\n\r\n      $scope.raiseRequest = function (service, requestClass) {\r\n        store.remove(\"currDataForm\");\r\n        var dfId = '0';\r\n        var dfClass = '';\r\n        switch (requestClass) {\r\n          case \"Incident\":\r\n            if (angular.isDefined(service.fk_df_support) && service.fk_df_support > 0) {\r\n              dfId = service.fk_df_support;\r\n              dfClass = requestClass;\r\n            }\r\n            break;\r\n          case \"Service Request\":\r\n            if (angular.isDefined(service.fk_df_onreq) && service.fk_df_onreq > 0) {\r\n              dfId = service.fk_df_onreq;\r\n              dfClass = requestClass;\r\n            }\r\n            break;\r\n          case \"Subscription\":\r\n            if (angular.isDefined(service.fk_df_onsub) && service.fk_df_onsub > 0) {\r\n              dfId = service.fk_df_onsub;\r\n              dfClass = requestClass;\r\n            }\r\n            break;\r\n        }\r\n        $rootScope.dataFormID = dfId;\r\n        $rootScope.dataFormClass = dfClass;\r\n\r\n        if (dfId !== '0') {\r\n          //Get subscription details\r\n          servicesService.getSubscriptionRecord(service.subs_id).then(function (objSubscription) {\r\n            var objRequest = {\r\n              dataFormID: dfId,\r\n              requestClass: dfClass,\r\n              serviceDetails: service,\r\n              subscription: objSubscription\r\n            };\r\n            store.set(\"currDataForm\", objRequest);\r\n            $state.go('requestwizard');\r\n          });\r\n        } else {\r\n          wssLogging.logger('No Wizard has been set up for this Service [' + service.vsb_title + ']. Please contact your Service Desk with the name of the Service to report this configuration issue.', \"ERROR\", \"ServiceListCtrl::raiseRequest\", false, true, \"Request Wizard Error!\");\r\n        }\r\n      };\r\n\r\n      $scope.selectCategoryGroup = function (cat, evt) {\r\n        cat.open = !cat.open;\r\n        evt.stopPropagation();\r\n      };\r\n\r\n      $scope.$on('logout', function () {\r\n        $scope.custServices = {};\r\n      });\r\n\r\n    }\r\n\r\n  }\r\n\r\n\r\n})();"]}
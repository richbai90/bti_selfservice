{"version":3,"sources":["../../../_itsm_default_v2_template/app/controllers/login.sso.ctrl.js"],"names":["angular","module","controller","LoginSSOController","$inject","$http","$scope","$rootScope","SWSessionService","$state","store","RequestService","wssLogging","$location","loggingIn","images","wssBranding","loginImage","sessServ","loginFailed","sspConfig","ssoEnabled","go","login","url","ssoAddress","method","port","headers","params","selfServiceInstance","then","quote","isDefined","data","error","connErrorBody","connErrorTitle","connErrorType","strErrorText","indexOf","sendToast","username","custid","sessionId","sessionConfig","bindSession","getSelfServiceConfig","wssConfig","get","getCustomerDetails","ac_id","custDetails","getAuthCount","response","numAuths","goToPath","newPath","path","toastType","toastBody","toastTitle","previousLogin","$on"],"mappings":"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","file":"login.sso.ctrl.js","sourcesContent":["(function () {\r\n    'use strict';\r\n    angular\r\n        .module('swSelfService')\r\n        .controller('LoginSSOController', LoginSSOController);\r\n\r\n    LoginSSOController.$inject = ['$http','$scope','$rootScope','SWSessionService','$state','store','RequestService','wssLogging', '$location'];\r\n\r\n    function LoginSSOController($http, $scope, $rootScope, SWSessionService, $state, store, RequestService, wssLogging, $location)\r\n    {\r\n      //$scope.loggingIn allows the tracking of when a customer has clicked the Login button, to when the login process has finished.\r\n      $scope.loggingIn = false;\r\n      $scope.images = wssBranding.loginImage;\n      $scope.sessServ = SWSessionService;\r\n\t  $scope.loginFailed = false;\r\n\r\n      if($scope.sessServ.sspConfig.ssoEnabled === false){\r\n        $state.go('login');\r\n      }\r\n\r\n      $scope.login = function(){\r\n        $http({\r\n          url: $scope.sessServ.sspConfig.ssoAddress,\r\n          method: 'POST',\r\n          port: 80,\r\n          headers: {\r\n            \"Cache-Control\":'no-cache',\r\n            'Accept': 'text/json',\r\n            \"Accept-Language\":'en-GB',\r\n            \"Content-Type\":'text/xmlmc; charset=UTF-8'\r\n          },\r\n          params: {\r\n            \"wssinstance\":$scope.sessServ.sspConfig.selfServiceInstance\r\n          }\r\n        }).then(function(quote) {\r\n\t\t\t\r\n\t\t\tif(angular.isDefined(quote.data.error))\r\n\t\t\t{\r\n\t\t\t\t//-- Authentication error. Possibly anonymous logon, incorrect cutomer password or incorrect rights\r\n\t\t\t\t//-- console.log(quote.data.error);\r\n\t\t\t\t\r\n\t\t\t\tvar connErrorBody = \"\";\r\n\t\t\t\tvar connErrorTitle = 'Authentication Error!';\r\n\t\t\t\tvar connErrorType = \"error\";\r\n\t\t\t\tvar strErrorText = quote.data.error;\r\n\t\t\t\t\r\n\t\t\t\tif (strErrorText.indexOf(\"You do not have the rights\") !== -1)\r\n\t\t\t\t{\r\n\t\t\t\t\tconnErrorBody = 'You do not have access to this system. Please contact your Service Desk to request access.';\r\n\t\t\t\t}\r\n\t\t\t\telse if (strErrorText.indexOf(\"This account has been locked\") !== -1)\r\n\t\t\t\t{\r\n\t\t\t\t\tconnErrorBody = 'This account has been locked. Please contact the Service Desk for assistance.';\r\n\t\t\t\t}\r\n\t\t\t\telse\r\n\t\t\t\t{\r\n\t\t\t\t\tconnErrorBody = 'You are not authorized to access this system. Please contact your Service Desk to request access.';\r\n\t\t\t\t}\r\n\t\t\t\twssLogging.sendToast(connErrorType, connErrorBody, connErrorTitle);\r\n\t\t\t\t\r\n\t\t\t\t//-- Display login screen\r\n\t\t\t\t$scope.loginFailed = true;\r\n\t\t\t}\r\n\t\t\telse\r\n\t\t\t{\r\n\t\t\t\t$scope.sessServ.username = quote.data.custid;\r\n\t\t\t\t$scope.sessServ.sessionId = quote.data.sessionId;\r\n\t\t\t\t$scope.sessServ.sessionConfig = quote.data;\r\n\t\t\t\t$scope.sessServ.bindSession($scope.sessServ.sessionId).then(function(){\r\n\t\t\t\t\t$scope.sessServ.getSelfServiceConfig($scope.sessServ.username).then(function(){\r\n\t\t\t\t\t\t$scope.sessServ.wssConfig = store.get(\"wssConfig\");\r\n\t\t\t\t\t\t$scope.sessServ.getCustomerDetails(quote.data[1], $scope.sessServ.wssConfig.ac_id).then(function(custDetails){\r\n\t\t\t\t\t\t\t//Get number of authorisations, stick it in rootScope\r\n\t\t\t\t\t\t\tRequestService.getAuthCount().then(function(response){\r\n\t\t\t\t\t\t\t  $scope.sessServ.numAuths = response;\r\n\t\t\t\t\t\t\t  if( $rootScope.goToPath !== '/' &&\r\n\t\t\t\t\t\t\t\t  $rootScope.goToPath !== '/login' &&\r\n\t\t\t\t\t\t\t\t  $rootScope.goToPath !== '/loginsso' &&\r\n\t\t\t\t\t\t\t\t  $rootScope.goToPath !== '/loginmanual' ){\r\n\t\t\t\t\t\t\t\tvar newPath = $rootScope.goToPath;\r\n\t\t\t\t\t\t\t\t$rootScope.goToPath = '';\r\n\t\t\t\t\t\t\t\t$location.path(newPath);\r\n\t\t\t\t\t\t\t  } else {\r\n\t\t\t\t\t\t\t\t$state.go('home');\r\n\t\t\t\t\t\t\t  }\r\n\t\t\t\t\t\t\t}, function(error){\r\n\t\t\t\t\t\t\t  var toastType = \"error\";\r\n\t\t\t\t\t\t\t  var toastBody = \"There has been an error in retrieving your authorisations count.\";\r\n\t\t\t\t\t\t\t  var toastTitle = \"Logon Error!\";\r\n\t\t\t\t\t\t\t  wssLogging.sendToast(toastType, toastBody, toastTitle);\r\n\r\n\t\t\t\t\t\t\t  if( $rootScope.goToPath !== '/' &&\r\n\t\t\t\t\t\t\t\t  $rootScope.goToPath !== '/login' &&\r\n\t\t\t\t\t\t\t\t  $rootScope.goToPath !== '/loginsso' &&\r\n\t\t\t\t\t\t\t\t  $rootScope.goToPath !== '/loginmanual' ){\r\n\t\t\t\t\t\t\t\tvar newPath = $rootScope.goToPath;\r\n\t\t\t\t\t\t\t\t$rootScope.goToPath = '';\r\n\t\t\t\t\t\t\t\t$location.path(newPath);\r\n\t\t\t\t\t\t\t  } else {\r\n\t\t\t\t\t\t\t\t$state.go('home');\r\n\t\t\t\t\t\t\t  }\r\n\t\t\t\t\t\t\t});\r\n\t\t\t\t\t\t});\r\n\t\t\t\t\t});\r\n\t\t\t\t});\r\n\t\t\t}\r\n\t\t},\r\n\t\tfunction(error) {\r\n\t\t\t//-- Authentication error. Possibly cancelled authentication.\r\n\t\t\t//-- console.log(error);\r\n\t\t\t\r\n\t\t\tvar connErrorTitle = 'Authentication Error!';\r\n\t\t\tvar connErrorType = \"error\";\r\n\t\t\tvar connErrorBody = 'You are not authorized to access this system. Please contact your Service Desk to request access.';\r\n\t\t\twssLogging.sendToast(connErrorType, connErrorBody, connErrorTitle);\r\n\t\t\t\r\n\t\t\t//-- Display login screen\r\n\t\t\t$scope.loginFailed = true;\r\n\t\t});\r\n\t  };\r\n\n      if($scope.sessServ.ssoEnabled === true){\r\n        if($scope.sessServ.previousLogin === false){\r\n          $scope.login();\r\n        }\r\n      }\r\n\r\n      //Watch for logout broadcast to clean up session-specific data ready for a new user\r\n      $scope.$on('logout',function(){\r\n      //  SWSessionService = {};\r\n      });\r\n\r\n\r\n    }\r\n\r\n})();\r\n"]}